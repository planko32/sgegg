<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo Test Panel – Members & Balance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #f9fafb;
      margin: 0;
      padding: 16px;
    }
    .card {
      background: #020617;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 0 0 1px rgba(148,163,184,0.25);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    h2 {
      font-size: 16px;
      margin: 0 0 8px;
    }
    .muted {
      color: #9ca3af;
      font-size: 13px;
    }
    .pill {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.8);
      font-size: 12px;
      color: #a5b4fc;
      border: 1px solid rgba(129,140,248,0.4);
      margin-right: 6px;
    }
    .value {
      font-weight: 600;
      color: #e5e7eb;
      font-size: 15px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    label {
      font-size: 13px;
      color: #9ca3af;
    }
    input {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      color: #e5e7eb;
      font-size: 14px;
      outline: none;
      min-width: 90px;
    }
    input:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.45);
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0b1120;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:active {
      transform: scale(0.97);
    }
    .toast {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%) translateY(100%);
      background: #0f172a;
      color: #e5e7eb;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 10px 40px rgba(15,23,42,0.7);
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease-out;
      border: 1px solid rgba(148,163,184,0.4);
      z-index: 50;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(30,64,175,0.5);
      text-align: left;
      white-space: nowrap;
    }
    th {
      color: #9ca3af;
      font-weight: 500;
      font-size: 11px;
    }
    td.type {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .04em;
    }
    td.amount {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Demo Test – Wallet & Members</h1>
    <p class="muted">
      هذه الصفحة فقط للاختبار داخل مشروعك: زيادة الرصيد، تجربة السحب، وزيادة عدد الأعضاء النشطين.
      كلها محفوظة في المتصفح (localStorage) وتستخدم نفس <code>wallet.js</code>.
    </p>
    <div class="grid">
      <div>
        <div class="pill">USDT Balance</div>
        <div class="value" id="usdt-balance">0.00</div>
      </div>
      <div>
        <div class="pill">Total Income (Personal)</div>
        <div class="value" id="total-income">0.00</div>
      </div>
      <div>
        <div class="pill">Transactions Count</div>
        <div class="value" id="tx-count">0</div>
      </div>
      <div>
        <div class="pill">Active Members (Demo)</div>
        <div class="value" id="active-members">0</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Increase Balance (Test Deposit)</h2>
    <p class="muted">
      هذا الزر يضيف رصيد USDT ويضيف عملية <b>DEPOSIT</b> إلى سجل العمليات في محفظة DemoWallet.
    </p>
    <div class="row">
      <label for="dep-amount">Amount (USDT):</label>
      <input id="dep-amount" type="number" min="1" step="0.01" value="50" />
      <button id="btn-deposit">Add Test Deposit</button>
    </div>
  </div>

  <div class="card">
    <h2>Test Withdraw</h2>
    <p class="muted">
      هذا الزر يستدعي <code>DemoWallet.withdraw()</code> ويطبّق منطق السحب نفسه المستخدم في صفحة السحب.
    </p>
    <div class="row">
      <label for="wd-amount">Amount (USDT):</label>
      <input id="wd-amount" type="number" min="1" step="0.01" value="20" />
      <button id="btn-withdraw">Create Test Withdraw</button>
    </div>
  </div>

  <div class="card">
    <h2>Active Members (Demo Counter)</h2>
    <p class="muted">
      هذا العداد فقط للتجربة، يتم تخزينه في <code>demoWalletState_v1.testActiveMembers</code>.
      يمكنك لاحقاً استخدامه في صفحات الفريق أو المستويات إن أحببت.
    </p>
    <div class="row">
      <button id="btn-add-member">+ Add Active Member</button>
      <button id="btn-reset-members">Reset Members</button>
    </div>
  </div>

  <div class="card">
    <h2>Last Transactions</h2>
    <p class="muted">آخر 10 عمليات في DemoWallet (دخل، سحب، إيداع، سواپ...)</p>
    <table>
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Currency</th>
          <th>Amount</th>
          <th>Net</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tx-body">
      </tbody>
    </table>
  </div>

  <div class="toast" id="toast"></div>

  <script src="wallet.js"></script>
  <script>
    (function () {
      function showToast(msg) {
        var t = document.getElementById("toast");
        if (!t) return;
        t.textContent = msg;
        t.classList.add("show");
        setTimeout(function () {
          t.classList.remove("show");
        }, 1800);
      }

      function readState() {
        if (!window.DemoWallet || typeof window.DemoWallet.getState !== "function") {
          return null;
        }
        try {
          return window.DemoWallet.getState();
        } catch (e) {
          console.error("Failed to read state", e);
          return null;
        }
      }

      function saveState(st) {
        if (!st || !window.DemoWallet || typeof window.DemoWallet.saveState !== "function") return;
        try {
          window.DemoWallet.saveState(st);
        } catch (e) {
          console.error("Failed to save state", e);
        }
      }

      function formatNumber(v) {
        var n = parseFloat(v);
        if (!isFinite(n)) n = 0;
        return n.toFixed(2);
      }

      function formatTime(iso) {
        if (!iso) return "-";
        var d = new Date(iso);
        if (isNaN(d.getTime())) return "-";
        var y = d.getFullYear();
        var m = String(d.getMonth() + 1).padStart(2, "0");
        var day = String(d.getDate()).padStart(2, "0");
        var hh = String(d.getHours()).padStart(2, "0");
        var mm = String(d.getMinutes()).padStart(2, "0");
        return y + "-" + m + "-" + day + " " + hh + ":" + mm;
      }

      function refresh() {
        if (!window.DemoWallet || typeof window.DemoWallet.getWallet !== "function") return;
        var wallet = window.DemoWallet.getWallet();
        var st = readState() || {};

        var usdt = document.getElementById("usdt-balance");
        var tincome = document.getElementById("total-income");
        var tcount = document.getElementById("tx-count");
        var amEl = document.getElementById("active-members");

        if (usdt) usdt.textContent = formatNumber(wallet.balance);
        if (tincome) tincome.textContent = formatNumber(wallet.totalIncome);
        if (tcount && st.transactions) tcount.textContent = st.transactions.length;

        var active = st.testActiveMembers || 0;
        if (amEl) amEl.textContent = active;

        var tbody = document.getElementById("tx-body");
        if (!tbody) return;
        tbody.innerHTML = "";
        var txs = (window.DemoWallet.getTransactions && window.DemoWallet.getTransactions()) || [];
        txs.slice(0, 10).forEach(function (tx) {
          var tr = document.createElement("tr");
          var tdTime = document.createElement("td");
          var tdType = document.createElement("td");
          var tdCur = document.createElement("td");
          var tdAmt = document.createElement("td");
          var tdNet = document.createElement("td");
          var tdStatus = document.createElement("td");

          tdTime.textContent = formatTime(tx.createdAt);
          tdType.textContent = tx.type || "-";
          tdType.className = "type";
          tdCur.textContent = tx.currency || "-";
          tdAmt.textContent = formatNumber(tx.amount);
          tdAmt.className = "amount";
          tdNet.textContent = formatNumber(tx.net != null ? tx.net : tx.amount);
          tdNet.className = "amount";
          tdStatus.textContent = tx.status || "-";

          tr.appendChild(tdTime);
          tr.appendChild(tdType);
          tr.appendChild(tdCur);
          tr.appendChild(tdAmt);
          tr.appendChild(tdNet);
          tr.appendChild(tdStatus);
          tbody.appendChild(tr);
        });
      }

      function setup() {
        var depBtn = document.getElementById("btn-deposit");
        var wdBtn = document.getElementById("btn-withdraw");
        var addMemberBtn = document.getElementById("btn-add-member");
        var resetMemberBtn = document.getElementById("btn-reset-members");

        if (depBtn) {
          depBtn.addEventListener("click", function () {
            var input = document.getElementById("dep-amount");
            var v = parseFloat(input && input.value);
            if (!(v > 0)) {
              showToast("Enter a valid deposit amount.");
              return;
            }
            var st = readState();
            if (!st) return;
            if (!st.balances) st.balances = { USDT: 0 };
            if (typeof st.balances.USDT !== "number") st.balances.USDT = 0;
            st.balances.USDT += v;
            if (!Array.isArray(st.transactions)) st.transactions = [];
            st.transactions.unshift({
              id: "tx_dep_" + Date.now(),
              type: "deposit",
              amount: v,
              currency: "USDT",
              status: "SUCCESS",
              fee: 0,
              net: v,
              createdAt: new Date().toISOString(),
              note: "Test deposit from demo panel"
            });
            saveState(st);
            showToast("Deposit added (demo).");
            refresh();
          });
        }

        if (wdBtn) {
          wdBtn.addEventListener("click", function () {
            var input = document.getElementById("wd-amount");
            var v = parseFloat(input && input.value);
            if (!(v > 0)) {
              showToast("Enter a valid withdraw amount.");
              return;
            }
            if (!window.DemoWallet || typeof window.DemoWallet.withdraw !== "function") {
              showToast("DemoWallet not available.");
              return;
            }
            var result = window.DemoWallet.withdraw(v);
            if (!result) {
              showToast("Not enough balance for withdraw.");
            } else {
              showToast("Withdraw request created (demo).");
            }
            refresh();
          });
        }

        if (addMemberBtn) {
          addMemberBtn.addEventListener("click", function () {
            var st = readState();
            if (!st) return;
            if (typeof st.testActiveMembers !== "number") st.testActiveMembers = 0;
            st.testActiveMembers += 1;
            saveState(st);
            showToast("One active member added (demo).");
            refresh();
          });
        }

        if (resetMemberBtn) {
          resetMemberBtn.addEventListener("click", function () {
            var st = readState();
            if (!st) return;
            st.testActiveMembers = 0;
            saveState(st);
            showToast("Active members reset.");
            refresh();
          });
        }

        refresh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setup);
      } else {
        setup();
      }
    })();
  </script>
</body>
</html>
